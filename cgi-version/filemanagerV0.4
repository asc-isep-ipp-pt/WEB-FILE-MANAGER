#!/bin/bash
######################################### LOCAL SETTINGS ##
DESC_TAIL="<hr/><small><i>Ultra Basic CGI based file manager 0.4, asc@isep.ipp.pt, 2019</i></small></body></html>"
SECRET_FILE="/.filemanager.secret"
for ROOT_DIR in /usr/local/apache2 /var/www /var/www/html /usr/local/apache2/htdocs /tmp ; do
 if [ -d ${ROOT_DIR} -a -w ${ROOT_DIR} ]; then break; fi
done
if [ "${ROOT_DIR}" == "/var/www/html" ]; then ROOT_DIR=/var/www; fi
TMP_DIR="/tmp/.filemanager"
###########################################################
function accessDenied {
        echo "<body bgcolor=gray>"
        echo "<h1>Sorry, access denied</h1>"
        echo "${DESC_TAIL}"
	cat - > /dev/null
        exit
}
###########
function htmlContent {
        echo -e "Content-Type: text/html; charset=iso-8859-1\r"
        echo -e "Content-language: en\r"
        echo -e "Connection: close\r\n\r"
        echo "<html><head><title>File Manager</title><script>"
        echo "function act(a,o,o2){"
        echo "document.main.action.value=a;"
        echo "document.main.object.value=o;"
        echo "document.main.object2.value=o2;"
        echo "document.main.submit(); }"
        echo "</script></head>"
}
###########
SECRET="$(cat ${SECRET_FILE} 2>/dev/null)"
if [ ${#SECRET} -lt 20 ]; then htmlContent; accessDenied; fi
if [ ! -d ${ROOT_DIR} ]; then htmlContent; accessDenied; fi
###########
if [ "${REQUEST_METHOD}" == "GET" ]; then
  htmlContent
  if [ ${#QUERY_STRING} -lt 20 ]; then accessDenied; fi
  if [ "${QUERY_STRING}" != "${SECRET}" ]; then accessDenied; fi
  ####
  echo "<body bgcolor=gray onLoad=\"act('list','','')\">"
  echo "<form name=main method=POST action=\"${SCRIPT_NAME}\">"
  echo "<input type=hidden name=secret value=\"${SECRET}\">"
  echo "<input type=hidden name=action value=list>"
  echo "<input type=hidden name=object value=>"
  echo "<input type=hidden name=object2 value=>"
  echo "<input type=hidden name=cwd value=>"
  echo "</form></body></html>"
  mkdir -p "${TMP_DIR}"
  chmod 700 "${TMP_DIR}"
  exit
fi

### It's a POST

if [ "${CONTENT_TYPE#multipart}" != "${CONTENT_TYPE}" ]; then # It's a file upload
        read BOUNDARY; BSIZE="${#BOUNDARY}"
        read LINE; read LINE
        read POST_SECRET; POST_SECRET="$(echo ${POST_SECRET}|tr -d "\r")"
        if [ "${POST_SECRET}" != "${SECRET}" ]; then cat - ; htmlContent; accessDenied; fi
        read LINE; read LINE; read LINE
        read POST_ACTION
        read LINE; read LINE; read LINE
        read POST_CWD; POST_CWD="$(echo ${POST_CWD}|tr -d "\r")"
        ################ NEXT ARE FILES
        UPTMPF="/tmp/.mupload$$"
        mkdir -p ${UPTMPF}
        csplit -s -z --suppress-matched -f ${UPTMPF}/xx - "/${BOUNDARY}*/" "{*}"
        for UF in ${UPTMPF}/* ; do
                FNAME="$(head -1 ${UF})"; FNAME="${FNAME#*filename=\"}"
                FNAME="${FNAME%\"*}"
                tail -n +4 ${UF}|head --bytes=-2 > "${ROOT_DIR}${POST_CWD}/${FNAME}"
        done
        rm -Rf ${UPTMPF}
else
        CONTENT="$(cat -)"
        POST_SECRET="${CONTENT#*secret=}"; POST_SECRET="${POST_SECRET%%&*}"
        ##
        POST_CWD="${CONTENT#*cwd=}"; POST_CWD="${POST_CWD%%&*}"
        POST_CWD="${POST_CWD//+/ }"; POST_CWD="$(printf '%b' "${POST_CWD//%/\\x}")"
        ##
        POST_ACTION="${CONTENT#*action=}"; POST_ACTION="${POST_ACTION%%&*}"

        POST_OBJECT="${CONTENT#*object=}"; POST_OBJECT="${POST_OBJECT%%&*}"
        POST_OBJECT="${POST_OBJECT//+/ }"; POST_OBJECT="$(printf '%b' "${POST_OBJECT//%/\\x}")"

        POST_OBJECT2="${CONTENT#*object2=}"; POST_OBJECT2="${POST_OBJECT2%%&*}"
        POST_OBJECT2="${POST_OBJECT2//+/ }"; POST_OBJECT2="$(printf '%b' "${POST_OBJECT2//%/\\x}")"
fi

if [ "${POST_SECRET}" != "${SECRET}" ]; then htmlContent; accessDenied; fi




case "${POST_ACTION}" in

        mkdir)
                mkdir "${ROOT_DIR}${POST_CWD}/${POST_OBJECT##*/}"  ;;
        rmrf)
                rm -Rf "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ;;

        mkfile)
                touch "${ROOT_DIR}${POST_CWD}/${POST_OBJECT##*/}"  ;;
        rm)
                if [ -d "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ]; then rmdir "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
                else rm "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"; fi ;;
        cd)
                if [ -d "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ]; then
                        POST_CWD="${POST_CWD}/${POST_OBJECT}"
                fi;;
        cdup)
                if [ -n "${POST_CWD}" ]; then
                        POST_CWD="${POST_CWD%/*}"
                fi;;

        copy)
  		mkdir -p "${TMP_DIR}"
  		chmod 700 "${TMP_DIR}"
                cp -Rp "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" "${TMP_DIR}/${POST_OBJECT}" ;;

        paste)
                mv "${TMP_DIR}/${POST_OBJECT}" "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ;;

        execPerm)
                if [ "${POST_OBJECT2}" == "grant" ]; then chmod +x "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
                else chmod -x "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"; fi
                POST_ACTION="details";;

        cdroot)
                POST_CWD="${POST_OBJECT}";;

        save)
                TEXT_CONTENT="${CONTENT#*textcontent=}"; TEXT_CONTENT="${TEXT_CONTENT%%&*}"
                TEXT_CONTENT="${TEXT_CONTENT//+/ }"; TEXT_CONTENT="$(printf '%b' "${TEXT_CONTENT//%/\\x}")"
                echo "${TEXT_CONTENT}"|tr -d "\r" > "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
                POST_ACTION="details";;

        rename)
                mv "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" "${ROOT_DIR}${POST_CWD}/${POST_OBJECT2##*/}" ;;

        download)
                echo -e "Content-Type: binary/data\r"
                echo -e "Content-Disposition: attachment; filename=\"${POST_OBJECT}\"\r"
                echo -e "Connection: close\r\n\r"
                cat "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
                exit;;
esac

if [ ! -d ${ROOT_DIR}${POST_CWD} ]; then POST_CWD=""; fi

htmlContent

echo "<body bgColor=grey>"
echo "<form name=main method=POST action=\"${SCRIPT_NAME}\">"
echo "<input type=hidden name=secret value=\"${SECRET}\">"
echo "<input type=hidden name=action value=>"
echo "<input type=hidden name=cwd value=\"${POST_CWD}\">"
echo "<input type=hidden name=object value=>"
echo "<input type=hidden name=object2 value=>"
echo "</form>"
echo "<table width=100% border=0 cellspacing=3><tr>"



### OBJECT'S DETAILS
##
if [ "${POST_ACTION}" == "details" ]; then
 OBJ="${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
 echo "<tr><td align=center colspan=3><h1>${OBJ}</h1></td></tr>"
 echo "<tr><td align=center colspan=3><hr></td></tr>"
 TYPE_CONTENT="`file -b \"${OBJ}\"`"
 echo "<tr><td align=center valign=middle bgColor=#C0C0C0><b>Object's name<br><br><big>${POST_OBJECT}</big></b></td>"
 echo "<td align=center valign=middle bgColor=#C0C0C0><b>Type/Content</b><br><pre>${TYPE_CONTENT}</pre></td>"
 echo "<td align=center valign=middle bgColor=#C0C0C0><b>Permissions/Owner/Group/...</b><pre>`cd \"${ROOT_DIR}${POST_CWD}\";ls -ld \"${POST_OBJECT}\"`</pre></td>"
 echo "<tr><td align=center colspan=3><hr></td></tr></table>"
 echo "<table width=100% border=0 cellspacing=3><tr>"
 echo "<td align=center><input type=button value=Cancel onclick=\"act('list','','');\"></td>"

 ## REMOVE NOT ALLOWED FOR SYMLINKS
 if [ -L "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ]; then echo "<td align=center></td>"
 else	 
  if [ -d "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ]; then
  echo "<td align=center><input type=button value=\"Remove Folder and Content\" onClick=\"javascript:act('rmrf','${POST_OBJECT}','');\"></td>"
  else
   echo "<td align=center><input type=button value=\"Remove File\" onClick=\"javascript:act('rm','${POST_OBJECT}','');\"></td>"
  fi
 fi

 echo "<td align=center><input id=newfilename type=text name=filename><br>"
 echo "<input type=button value=\"Rename Object\" onclick=\"act('rename','${POST_OBJECT}',document.getElementById('newfilename').value);\"></td>"
 echo "<td align=center><input type=button value=\"Copy Object to TMP\" onClick=\"javascript:act('copy','${POST_OBJECT}','');\"></td>"
 echo "<td align=center>"
 if [ -x "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}" ]; then
  echo "<input type=button value=\"Remove Execute Permission\" onclick=\"act('execPerm','${POST_OBJECT}','remove');\"><br/>"
 else
  echo "<input type=button value=\"Grant Execute Permission\" onclick=\"act('execPerm','${POST_OBJECT}','grant');\"></td>"
 fi
 echo "</tr><tr><td></td>"
 if [ ! -d "${OBJ}" ]; then
  if grep -i "<script" "${OBJ}" >/dev/null 2>&1 ; then
   echo "<td align=center></td>"
  else
   echo "<td align=center><input type=button value=\"Edit as a Text File\" onclick=\"act('edittext','${POST_OBJECT}','');\"></td>"
  fi
  echo "<td align=center></td>"
  echo "<td align=center><input type=button value=\"Download File\" onclick=\"act('download','${POST_OBJECT}','');\"></td>"
 fi
 echo "</tr></table>${DESC_TAIL}"
 exit
fi

### EDIT TEXT FILE
##
if [ "${POST_ACTION}" == "edittext" ]; then
  echo "<form name=save method=POST action=\"${SCRIPT_NAME}\">"
  echo "<tr><td align=center bgcolor=#B0C0B0><h2>${ROOT_DIR}${POST_CWD}/${POST_OBJECT}</h2></td>"
  echo "<td align=center><input type=submit value=\"Save File\"></td>"
  echo "<td align=center><input type=button value=Cancel onclick=\"act('details','${POST_OBJECT}','');\"></td></tr>"
  echo "<input type=hidden name=secret value=\"${SECRET}\">"
  echo "<input type=hidden name=action value=save>"
  echo "<input type=hidden name=cwd value=\"${POST_CWD}\">"
  echo "<input type=hidden name=object value=\"${POST_OBJECT}\">"
  echo "<tr><td align=center colspan=3><hr/>"
  echo "<textarea name=textcontent cols=120 rows=30>"
  cat "${ROOT_DIR}${POST_CWD}/${POST_OBJECT}"
  echo "</textarea><hr/></td></tr></table>${DESC_TAIL}"
  exit
fi



### FOLDER CONTENT LISTING
##
echo "<td align=center valign=middle bgcolor=#B0C0B0>"
echo "<input id=foldername type=text name=foldername><br>"
echo "<input type=button value=\"Create Folder\" onclick=\"act('mkdir',document.getElementById('foldername').value,'');\">"
echo "</td>"
echo "<td align=center valign=middle bgcolor=#B0C0B0>"
echo "<input id=filename type=text name=filename><br>"
echo "<input type=button value=\"Create Empty File\" onclick=\"act('mkfile',document.getElementById('filename').value,'');\">"
echo "</td>"
echo "<td align=center valign=middle bgcolor=#B0C0B0>"
echo "<form name=upload enctype=\"multipart/form-data\" method=POST action=\"${SCRIPT_NAME}\">"
echo "<input type=hidden name=secret value=\"${SECRET}\">"
echo "<input type=hidden name=action value=upload>"
echo "<input type=hidden name=cwd value=\"${POST_CWD}\">"
echo "<b>MULTIPLE FILES UPLOAD</b><p><input type=file name=filename multiple>"
echo "<input type=submit value=Upload>"
echo "</form></td>"
echo "<td align=center valign=middle bgcolor=#B0C0B0>TMP contents<hr>"
OBJ_LIST="$(ls -1 "${TMP_DIR}"|tr " " "\a")"
for OBJM in ${OBJ_LIST}; do
        OBJ="$(echo ${OBJM}|tr "\a" " ")"
        echo "<p>${OBJ} <input type=button value=Paste onClick=\"javascript:act('paste','${OBJ}','');\">"
done
echo "</td>"

echo "</tr></table><hr/><table width=100% border=0>"


echo -n "<tr><td><big><b><a href=\"javascript:act('cdroot','','');\"><font color=orange>${ROOT_DIR}</font></a>"
FLDL="${POST_CWD}"; FF=""; RFF=""
while [ "${FLDL#*/}" != "${FLDL}" ]; do
 FLDL="${FLDL#*/}"; FF="${FLDL%%/*}"
 RFF="${RFF}/${FF}"
 echo -n "/<a href=\"javascript:act('cdroot','${RFF}','');\">${FF}</a>"
done
echo "</b></big></td><td></td></tr>"

## ISSUE : names with spaces
OBJ_LIST="$(ls -1 "${ROOT_DIR}${POST_CWD}"|tr " " "\a")"

if [ -n "${POST_CWD}" ]; then
        echo "<tr><td><a href=\"javascript:act('cdup','','');\"><b>../</b></a></td><td></td></tr>"
        echo "<tr><td colspan=2><hr/></td></tr>"
fi
for OBJM in ${OBJ_LIST}; do
        OBJ="$(echo ${OBJM}|tr "\a" " ")"
        echo "<tr><td><input type=button value=Manage onClick=\"javascript:act('details','${OBJ}','');\">&nbsp;&nbsp;"
        if [ -d "${ROOT_DIR}${POST_CWD}/${OBJ}" ]; then
                echo "<a href=\"javascript:act('cd','${OBJ}','');\"><b>${OBJ}/</b></a></td></tr>"
        else
                echo "${OBJ}</td></tr>"
        fi
done
echo "</table>${DESC_TAIL}"
####
